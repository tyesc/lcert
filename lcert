#!/bin/bash

### Based on the work of Thomas Leister <thomas@metalhead.club>
### Original script https://github.com/ThomasLeister/root-certificate-deployment

IFS="."

usage() {
  echo "" 1>&2;
  echo -e "\e[1mNAME\e[0m" 1>&2;
  echo "" 1>&2;
  echo -e "\tlcert - load certificate" 1>&2;
  echo "" 1>&2;
  echo -e "\e[1mSYNOSIS\e[0m" 1>&2;
  echo "" 1>&2;
  echo -e "\tlcert [OPTIONS]... " 1>&2;
  echo "" 1>&2;
  echo -e "\e[1mDESCRIPTION\e[0m" 1>&2;
  echo -e "\tAutomatic cp and Load new cert.pem to certificate trust store of applications using NSS" 1>&2;
  echo "" 1>&2;
  echo -e "\t\e[1m-n\e[0m\tset name, with extention, of cert in /etc/ssl/certs/ , \e[1m-n exemple.cert.pem\e[0m" 1>&2;
  echo "" 1>&2;
  echo -e "\t\e[1m-p (OPTIONAL)\e[0m\tset the path of the certificate to copy into /etc/ssl/certs/ , \e[1m-p ./cert.pem\e[0m" 1>&2;
  echo "" 1>&2;
  echo -e "\e[1mEXEMPLE\e[0m" 1>&2;
  echo -e "\tlcert -n my-cert.pem" 1>&2;
  echo -e "\t> Do you want to load certificate in trust store of applications [y/n]? y" 1>&2;
  echo -e "\t> This process can take a long moment, please don't abort the task" 1>&2;
  echo -e "\t> Loaded !" 1>&2;
  echo "" 1>&2;
  echo -e "\tlcert -n my-cert.pem -p ./cert.pem" 1>&2;
  echo -e "\t> Do you want to copy ./cert.pem into /etc/ssl/certs/my-cert.pem [y/n]? y" 1>&2;
  echo -e "\t> ./cert.pem copied into /etc/ssl/certs/my-cert.pem" 1>&2;
  echo -e "\t> This process can take a long moment, please don't abort the task" 1>&2;
  echo -e "\t> Loaded !" 1>&2;

  exit 1;
}

load_in_trust_store() {
  sudo update-ca-certificates

  echo "This process can take a long moment, please don't abort the task"

  ###
  ### For cert8 (legacy - DBM)
  ###

  for certDB in $(find ~/ -name "cert8.db")
  do
      echo "cert8";
      CERT_DIR=$(dirname ${certDB});
      certutil -A -n "${CERT_NAME}" -t "TCu,Cu,Tu" -i ${CERT_FILE} -d dbm:${CERT_DIR}
  done

  ###
  ### For cert9 (SQL)
  ###

  for certDB in $(find ~/ -name "cert9.db")
  do
      echo "cert9";
      CERT_DIR=$(dirname ${certDB});
      certutil -A -n "${CERT_NAME}" -t "TCu,Cu,Tu" -i ${CERT_FILE} -d sql:${CERT_DIR}
  done
  echo "Loaded !"
}

while getopts "p:n:" arg; do
  case $arg in
    p)
      CERT_PATH=${OPTARG}
      ;;
    n)
      CERT_NAME=${OPTARG}
      ;;
    *)
      usage
      ;;
  esac
done

if [ -z "${CERT_PATH+x}" ]; then
  if [ -z "${CERT_NAME}" ]; then
    usage
  else
    read -p "Do you want to load certificate in trust store of applications [y/n]?" -n 1 -r
    echo "" 1>&2;

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      [[ "$0" = "${BASH_SOURCE}" ]] && exit 1 || return 1
    fi

    CERT_FILE="/etc/ssl/certs/${CERT_NAME}"

    read -ra ADDR <<< "${CERT_NAME}"
    CERT_NAME="${ADDR[0]} CA"

    load_in_trust_store

    exit 1 || return 1
  fi
else
  if [ -z "${CERT_NAME}" ]; then
    usage
  else
    read -p "Do you want to copy ${CERT_PATH} into /etc/ssl/certs/${CERT_NAME} [y/n]?" -n 1 -r
    echo "" 1>&2;

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      [[ "$0" = "${BASH_SOURCE}" ]] && exit 1 || return 1
    fi

    sudo cp ${CERT_PATH} /etc/ssl/certs/
    echo "${CERT_PATH} copied into /etc/ssl/certs/${CERT_NAME}"

    CERT_FILE="/etc/ssl/certs/${CERT_NAME}"

    read -ra ADDR <<< "${CERT_NAME}"
    CERT_NAME="${ADDR[0]} CA"

    load_in_trust_store

    exit 1 || return 1
  fi
fi
